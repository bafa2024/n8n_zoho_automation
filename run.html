<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoho Bills Automation Console — Run Details (Demo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <!-- Topbar -->
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-blue-600"></div>
        <div class="font-semibold text-slate-900">Zoho Bills Automation Console — Demo</div>
      </div>
      <nav class="flex gap-1 rounded-xl bg-slate-100 p-1">
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="index.html">Dashboard</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="settings.html">Settings</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="logs.html">Logs</a>
      </nav>
      <div></div>
    </div>
  </div>

  <main class="mx-auto max-w-7xl px-4 py-6">
    <div id="runContainer" class="space-y-6"></div>
  </main>

  <script>
    const STATUS = {
      success: { label: "Success", chip: "bg-green-100 text-green-800 border-green-200" },
      warning: { label: "Warning", chip: "bg-amber-100 text-amber-800 border-amber-200" },
      error:   { label: "Error",   chip: "bg-red-100 text-red-800 border-red-200" },
      pending: { label: "Pending", chip: "bg-slate-100 text-slate-700 border-slate-200" },
    };

    function loadRuns() {
      const raw = localStorage.getItem("runs");
      if (!raw) return [];
      try { return JSON.parse(raw) } catch { return [] }
    }
    function saveRuns(runs) { localStorage.setItem("runs", JSON.stringify(runs)) }

    function findRun(id) {
      return loadRuns().find(r => r.id === id);
    }

    function chip(status) {
      const s = STATUS[status] || STATUS.pending;
      return `
        <span class="inline-flex items-center border px-2.5 py-0.5 rounded-full text-xs font-medium ${s.chip}">
          <span class="mr-1 h-1.5 w-1.5 rounded-full bg-current/60"></span>${s.label}
        </span>
      `;
    }

    function currency(n, code = "RM") {
      return `${code} ${Number(n||0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function headerCard(run) {
      return `
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-slate-900 font-semibold mb-3">Header</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            ${kv("Vendor", run.vendor || "—")}
            ${kv("Invoice", run.invoiceNo || "—")}
            ${kv("Date", run.date || "—")}
            ${kv("Terms", run.terms ? run.terms + " days" : "—")}
            ${kv("Agent", run.agent || "—")}
            ${kv("File", run.file || "—")}
          </div>
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <div class="text-slate-500 text-sm mb-1">Bill-To</div>
              <div class="rounded-xl border border-slate-200 p-3">${run.billTo || "—"}</div>
            </div>
            <div>
              <div class="text-slate-500 text-sm mb-1">Ship-To</div>
              <div class="rounded-xl border border-slate-200 p-3">${run.shipTo || "—"}</div>
            </div>
          </div>
        </div>
      `;
    }

    function kv(k, v) {
      return `
        <div class="flex items-center justify-between py-1">
          <div class="text-slate-500 text-sm">${k}</div>
          <div class="text-slate-900 font-medium">${v}</div>
        </div>
      `;
    }

    function itemsTable(run) {
      const rows = (run.items || []).map((it, i) => `
        <tr class="hover:bg-slate-50">
          <td class="px-3 py-2 text-slate-600">${i + 1}</td>
          <td class="px-3 py-2 font-medium text-slate-900">${it.desc}</td>
          <td class="px-3 py-2 text-slate-700">${it.sku}</td>
          <td class="px-3 py-2 text-right">${it.qty}</td>
          <td class="px-3 py-2">${it.unit}</td>
          <td class="px-3 py-2 text-right">${Number(it.rate).toFixed(2)}</td>
          <td class="px-3 py-2 text-right">${it.disc}</td>
          <td class="px-3 py-2 text-right">${it.tax}</td>
          <td class="px-3 py-2 text-right">${(it.qty * it.rate * (1 - it.disc / 100)).toFixed(2)}</td>
        </tr>
      `).join("");
      return `
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-slate-900 font-semibold mb-3">Line items (${run.items?.length || 0})</div>
          <div class="overflow-auto">
            <table class="min-w-full">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs uppercase">#</th>
                  <th class="px-3 py-2 text-left text-xs uppercase">Description</th>
                  <th class="px-3 py-2 text-left text-xs uppercase">SKU</th>
                  <th class="px-3 py-2 text-right text-xs uppercase">Qty</th>
                  <th class="px-3 py-2 text-left text-xs uppercase">Unit</th>
                  <th class="px-3 py-2 text-right text-xs uppercase">Rate</th>
                  <th class="px-3 py-2 text-right text-xs uppercase">Disc%</th>
                  <th class="px-3 py-2 text-right text-xs uppercase">Tax%</th>
                  <th class="px-3 py-2 text-right text-xs uppercase">Amount</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-200">
                ${rows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function totalsCard(run) {
      return `
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-slate-900 font-semibold mb-3">Totals</div>
          ${kv("Subtotal", currency(run.totals?.subtotal))}
          ${kv("Discount", currency(run.totals?.discount))}
          ${kv("Tax", currency(run.totals?.tax))}
          ${kv("Rounding", currency(run.totals?.rounding))}
          <div class="mt-2 border-t pt-2">
            ${kv("Total", currency(run.totals?.total))}
          </div>
        </div>
      `;
    }

    function matchingCard(run) {
      const unitList = ["PC","SET","Unit"].join(", ");
      return `
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <div class="text-slate-900 font-semibold mb-3">Matching decisions</div>
          <ul class="list-disc pl-5 text-slate-700 space-y-1 text-sm">
            <li>Vendor match: high confidence (name + reg no + address)</li>
            <li>${(run.items?.length || 0) - 2} exact items by SKU, 2 created with supplier suffix</li>
            <li>Units validated: ${unitList}</li>
          </ul>
        </div>
      `;
    }

    function warningsCard(run) {
      if (!run.notes || !run.notes.length) return "";
      const items = run.notes.map(n => `<li>${n}</li>`).join("");
      return `
        <div class="rounded-2xl border border-amber-200 bg-amber-50 p-4">
          <div class="text-amber-800 font-semibold mb-2">Warnings</div>
          <ul class="list-disc pl-5 text-amber-800 space-y-1 text-sm">${items}</ul>
        </div>
      `;
    }

    function render(run) {
      const container = document.getElementById("runContainer");
      container.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <a href="index.html" class="rounded-xl border px-3 py-2 text-slate-600 hover:bg-slate-50">Back</a>
            <div class="text-xl font-semibold text-slate-900">Run ${run.id}</div>
            ${chip(run.status)}
            <div class="text-slate-500">Duration ${run.duration}s</div>
          </div>
          <div class="flex items-center gap-2">
            ${run.billLink ? `<a class="rounded-xl bg-blue-600 text-white px-3 py-2 hover:bg-blue-700" href="${run.billLink}" target="_blank" rel="noreferrer">Open in Zoho Books</a>` : ""}
            <button id="btnDownload" class="rounded-xl border px-3 py-2 hover:bg-slate-50">Download parsed JSON</button>
            <button id="btnRerun" class="rounded-xl border px-3 py-2 hover:bg-slate-50">Re-run</button>
            <button id="btnReviewed" class="rounded-xl bg-slate-900 text-white px-3 py-2">Mark reviewed</button>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-6">
          <div class="lg:col-span-2 space-y-4">
            ${headerCard(run)}
            ${itemsTable(run)}
          </div>
          <div class="space-y-4">
            ${totalsCard(run)}
            ${matchingCard(run)}
            ${warningsCard(run)}
          </div>
        </div>
      `;

      // actions
      document.getElementById("btnDownload")?.addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(run, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `${run.id}.json`; a.click();
        URL.revokeObjectURL(url);
      });
      document.getElementById("btnRerun")?.addEventListener("click", () => {
        const runs = loadRuns();
        const idx = runs.findIndex(r => r.id === run.id);
        if (idx >= 0) {
          runs[idx] = { ...runs[idx], status: "success", notes: [], billLink: runs[idx].billLink || "https://books.zoho.com/app#/bills/preview" };
          saveRuns(runs);
          render(runs[idx]);
        }
      });
      document.getElementById("btnReviewed")?.addEventListener("click", () => {
        const runs = loadRuns();
        const idx = runs.findIndex(r => r.id === run.id);
        if (idx >= 0) {
          runs[idx] = { ...runs[idx], reviewed: true };
          saveRuns(runs);
          alert(`Run ${run.id} marked as reviewed.`);
        }
      });
    }

    function init() {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      const run = id ? findRun(id) : null;
      if (!run) {
        document.getElementById("runContainer").innerHTML = `
          <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
            <div class="text-lg font-semibold text-slate-900 mb-2">Run not found</div>
            <div class="text-slate-600">Go back to the <a class="text-blue-600 hover:underline" href="index.html">Dashboard</a> and select a run.</div>
          </div>
        `;
        return;
      }
      render(run);
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
