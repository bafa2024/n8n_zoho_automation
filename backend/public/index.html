<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoho Bills Automation Console — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <!-- Nav -->
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-blue-600"></div>
        <div class="font-semibold text-slate-900">Zoho Bills Automation — Demo</div>
      </div>
      <nav class="flex gap-1 rounded-xl bg-slate-100 p-1">
        <a class="px-3 py-1.5 rounded-lg text-sm bg-white shadow text-slate-900" href="index.html">Dashboard</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="settings.html">Settings</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="logs.html">Logs</a>
      </nav>
      <div></div>
    </div>
  </div>

  <main class="mx-auto max-w-7xl p-4 space-y-8">
    <!-- Status banner -->
    <div id="statusBanner" class="rounded-xl bg-slate-200 px-3 py-2 text-sm text-slate-800"></div>

    <!-- Upload -->
    <div id="dropZone" class="rounded-2xl border-2 border-dashed border-slate-300 bg-white p-6 text-center">
      <p class="text-slate-900 font-semibold">Drag & drop PDFs or click to upload</p>
      <input id="fileInput" class="hidden" type="file" accept=".pdf" multiple />
      <button id="selectFiles" class="mt-2 rounded-xl bg-slate-900 text-white px-4 py-2">Browse</button>
      <div id="uploadStatus" class="mt-2 text-sm text-slate-600"></div>
    </div>

    <!-- Runs table -->
    <div>
      <div class="mb-2 text-slate-900 font-semibold">Recent runs</div>
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-2">Run ID</th>
              <th class="px-4 py-2">Invoice</th>
              <th class="px-4 py-2">Vendor</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Items</th>
              <th class="px-4 py-2">Bill</th>
              <th class="px-4 py-2">When</th>
            </tr>
          </thead>
          <tbody id="runsTbody" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
      <div class="flex justify-between my-4">
        <button id="prevPage" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">Prev</button>
        <button id="nextPage" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">Next</button>
      </div>
    </div>
  </main>

  <script>
    const API_DEFAULT = 'http://localhost:5050';
    const API_BASE = (localStorage.getItem('API_BASE') || API_DEFAULT).replace(/\/$/, '');

    let nextCursor = null;
    let prevCursors = [];
    const PAGE_SIZE = 20;

    async function apiInfo(){
      const r = await fetch(API_BASE + '/api/info');
      return r.json();
    }

    async function apiListRuns(limit, cursor){
      const u = new URL(API_BASE + '/api/runs');
      if (limit) u.searchParams.set('limit', String(limit));
      if (cursor) u.searchParams.set('cursor', String(cursor));
      const r = await fetch(u.toString());
      return await r.json();
    }

    async function apiIngest(file){
      const fd = new FormData();
      fd.append('file', file, file.name || 'upload.pdf');
      const r = await fetch(API_BASE + '/api/runs/ingest', { method: 'POST', body: fd });
      return await r.json();
    }

    function ago(ts){
      const d = Date.now() - Number(ts||0);
      const s = Math.floor(d/1000);
      const m = Math.floor(s/60);
      const h = Math.floor(m/60);
      const day = Math.floor(h/24);
      if (day>0) return day+'d ago';
      if (h>0) return h+'h ago';
      if (m>0) return m+'m ago';
      return s+'s ago';
    }

    function renderRuns(runs){
      const tb = document.getElementById('runsTbody');
      tb.innerHTML = '';
      for (const run of runs){
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 cursor-pointer';
        tr.innerHTML = `
          <td class="px-4 py-2 font-mono text-sm text-blue-700 underline">${run.id}</td>
          <td class="px-4 py-2">${run.invoiceNo || '—'}</td>
          <td class="px-4 py-2">${run.vendor || '—'}</td>
          <td class="px-4 py-2">${run.status}</td>
          <td class="px-4 py-2">${(run.items||[]).length}</td>
          <td class="px-4 py-2">${run.billLink ? '<a href="'+run.billLink+'" target="_blank">Open</a>' : '—'}</td>
          <td class="px-4 py-2">${ago(run.createdAt)}</td>
        `;
        tr.addEventListener('click', (e)=>{
          if (!e.target.closest('a')){
            location.href = 'run.html?id=' + run.id;
          }
        });
        tb.appendChild(tr);
      }
    }

    async function loadPage(cursor, back=false){
      const { runs, nextCursor: nc } = await apiListRuns(PAGE_SIZE, cursor);
      renderRuns(runs);
      nextCursor = nc;
      if (!back && cursor) prevCursors.push(cursor);
      document.getElementById('prevPage').disabled = prevCursors.length===0;
      document.getElementById('nextPage').disabled = !nextCursor;
    }

    function initUpload(){
      const dz = document.getElementById('dropZone');
      const input = document.getElementById('fileInput');
      dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('bg-slate-50'); });
      dz.addEventListener('dragleave', e=>{ dz.classList.remove('bg-slate-50'); });
      dz.addEventListener('drop', async e=>{
        e.preventDefault(); dz.classList.remove('bg-slate-50');
        const files = Array.from(e.dataTransfer.files);
        for (const f of files){ await apiIngest(f); }
        loadPage(null);
      });
      document.getElementById('selectFiles').addEventListener('click', ()=> input.click());
      input.addEventListener('change', async e=>{
        for (const f of e.target.files){ await apiIngest(f); }
        loadPage(null);
      });
    }

    async function init(){
      const info = await apiInfo();
      document.getElementById('statusBanner').textContent =
        `Zoho: ${info.zoho.mode} | Parser: ${info.parser.configured?'on':'off'}`;
      initUpload();
      await loadPage(null);
      document.getElementById('nextPage').addEventListener('click', ()=> loadPage(nextCursor));
      document.getElementById('prevPage').addEventListener('click', ()=> {
        const prev = prevCursors.pop();
        loadPage(prev, true);
      });
    }
    init();
  </script>
</body>
</html>
