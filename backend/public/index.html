<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoho Bills Automation Console — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-blue-600"></div>
        <div class="font-semibold text-slate-900">Zoho Bills Automation — Demo</div>
        <span id="ver" class="ml-2 text-xs text-slate-500">v0.4.1.1</span>
      </div>
      <nav class="flex gap-1 rounded-xl bg-slate-100 p-1">
        <a class="px-3 py-1.5 rounded-lg text-sm bg-white shadow text-slate-900" href="index.html">Dashboard</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="settings.html">Settings</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="logs.html">Logs</a>
      </nav>
      <div></div>
    </div>
  </div>

  <main class="mx-auto max-w-7xl p-4 space-y-8">
    <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-slate-900 font-semibold">Upload vendor bills (PDF)</div>

          <div class="text-slate-500 text-sm">Files are parsed server-side (or simulated if parser is off). Duplicates are detected by SHA-256.</div>
        </div>
        <div class="flex items-center gap-2">
          <input id="fileInput" class="hidden" type="file" accept=".pdf" multiple />
          <button id="selectFiles" class="rounded-xl bg-slate-900 text-white px-4 py-2">Select files</button>
        </div>
      </div>
      <div id="uploadStatus" class="mt-3 text-sm text-slate-600"></div>
    </div>

    <div>
      <div class="mb-2 text-slate-900 font-semibold">Recent runs</div>
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Run ID</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Invoice</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Vendor</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Status</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Items</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">Bill</th>
              <th class="px-4 py-2 text-left text-xs font-medium uppercase">When</th>
            </tr>
          </thead>
          <tbody id="runsTbody" class="divide-y divide-slate-200 text-slate-800"></tbody>
        </table>
      </div>
      <div class="flex justify-center my-4">
        <button id="loadMore" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">Load more</button>
      </div>
    </div>
  </main>

  <script>
    const API_DEFAULT = 'http://localhost:5050';
    const API_BASE = (localStorage.getItem('API_BASE') || API_DEFAULT).replace(/\/$/, '');
    const STATUS = {
      success: { label: "Success", chip: "bg-green-100 text-green-800 border-green-200" },
      warning: { label: "Warning", chip: "bg-amber-100 text-amber-800 border-amber-200" },
      error:   { label: "Error",   chip: "bg-red-100 text-red-800 border-red-200" },
      pending: { label: "Pending", chip: "bg-slate-100 text-slate-700 border-slate-200" },
    };

    let nextCursor = null;
    const PAGE_SIZE = 30;

    function fmtMoney(n){ return (n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
    function ago(ts){
      const d = Date.now() - Number(ts||0);
      const s = Math.floor(d/1000);
      const m = Math.floor(s/60);
      const h = Math.floor(m/60);
      const day = Math.floor(h/24);
      if (day>0) return day + (day===1?' day':' days') + ' ago';
      if (h>0) return h + (h===1?' hour':' hours') + ' ago';
      if (m>0) return m + (m===1?' min':' mins') + ' ago';
      return s + 's ago';
    }

    async function apiListRuns(limit, cursor){
      const u = new URL(API_BASE + '/api/runs');
      if (limit) u.searchParams.set('limit', String(limit));
      if (cursor) u.searchParams.set('cursor', String(cursor));
      const r = await fetch(u.toString());
      if (!r.ok) throw new Error('list failed');
      return await r.json(); // {runs, nextCursor}
    }

    async function apiIngest(file){
      const fd = new FormData();
      fd.append('file', file, file.name || 'upload.pdf');
      const r = await fetch(API_BASE + '/api/runs/ingest', { method: 'POST', body: fd });
      if (!r.ok) throw new Error('ingest failed ' + r.status);
      return await r.json();
    }

    function renderRuns(runs, append=false){
      const tb = document.getElementById('runsTbody');
      if (!append) tb.innerHTML = '';
      for (const run of runs){
        const st = STATUS[run.status] || STATUS.pending;
        const itemsCount = (run.items||[]).length;
        const bill = run.billLink ? '<a href="'+run.billLink+'" target="_blank" class="text-blue-700 underline">Open</a>' : '<span class="text-slate-500">—</span>';
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 cursor-pointer';
        tr.innerHTML = `
          <td class="px-4 py-2 font-mono text-sm text-blue-700 underline">${run.id}</td>
          <td class="px-4 py-2">${run.invoiceNo || '<span class="text-slate-500">—</span>'}</td>
          <td class="px-4 py-2">${run.vendor || '<span class="text-slate-500">—</span>'}</td>
          <td class="px-4 py-2"><span class="text-xs px-2 py-1 rounded-full border ${st.chip}">${st.label}</span></td>
          <td class="px-4 py-2">${itemsCount}</td>
          <td class="px-4 py-2">${bill}</td>
          <td class="px-4 py-2 text-slate-500">${ago(run.createdAt)}</td>
        `;
        tr.addEventListener('click', (e)=>{
          const a = e.target.closest('a');
          if (a) return;
          location.href = 'run.html?id=' + encodeURIComponent(run.id);
        });
        tb.appendChild(tr);
      }
    }

    async function loadInitial(){
      try {
        const { runs, nextCursor: nc } = await apiListRuns(PAGE_SIZE, null);
        renderRuns(runs, false);
        nextCursor = nc;
        document.getElementById('loadMore').disabled = !nextCursor;
      } catch(e){
        document.getElementById('runsTbody').innerHTML = '<tr><td class="px-4 py-8 text-slate-500" colspan="7">Could not reach API at '+API_BASE+'.</td></tr>';
      }
    }

    async function loadMore(){
      if (!nextCursor) return;
      const btn = document.getElementById('loadMore');
      btn.textContent = 'Loading…';
      btn.disabled = true;
      try {
        const { runs, nextCursor: nc } = await apiListRuns(PAGE_SIZE, nextCursor);
        renderRuns(runs, true);
        nextCursor = nc;
      } finally {
        btn.textContent = nextCursor ? 'Load more' : 'No more';
        btn.disabled = !nextCursor;
      }
    }

    function init(){
      document.getElementById('selectFiles').addEventListener('click', ()=> document.getElementById('fileInput').click());
      document.getElementById('fileInput').addEventListener('change', async (e)=>{
        const out = document.getElementById('uploadStatus');
        const files = Array.from(e.target.files||[]);
        if (!files.length) return;
        let ok=0, fail=0;
        for (const f of files){
          out.textContent = 'Uploading ' + f.name + ' …';
          try { await apiIngest(f); ok++; }
          catch(err){ console.error(err); fail++; }
        }
        out.textContent = 'Done. ' + ok + ' uploaded' + (fail? (', '+fail+' failed'):'') + '.';
        await loadInitial();
        e.target.value = '';
      });
      document.getElementById('loadMore').addEventListener('click', loadMore);
      loadInitial();
    }
    init();
  </script>
</body>
</html>
