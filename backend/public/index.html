<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoho Bills Automation Console — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <!-- Nav -->
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-blue-600"></div>
        <div class="font-semibold text-slate-900">Zoho Bills Automation — Demo</div>
      </div>
      <nav class="flex gap-1 rounded-xl bg-slate-100 p-1">
        <a class="px-3 py-1.5 rounded-lg text-sm bg-white shadow text-slate-900" href="index.html">Dashboard</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="settings.html">Settings</a>
        <a class="px-3 py-1.5 rounded-lg text-sm text-slate-600 hover:text-slate-900" href="logs.html">Logs</a>
      </nav>
      <div></div>
    </div>
  </div>

  <main class="mx-auto max-w-7xl p-4 space-y-8">
    <!-- Status banner -->
    <div id="statusBanner" class="rounded-xl bg-slate-200 px-3 py-2 text-sm text-slate-800"></div>

    <!-- Upload -->
    <div id="dropZone" class="rounded-2xl border-2 border-dashed border-slate-300 bg-white p-6 text-center">
      <p class="text-slate-900 font-semibold">Drag & drop PDFs or click to upload</p>
      <form id="uploadForm" action="/upload" method="POST" enctype="multipart/form-data">
        <input type="file" id="fileInput" name="file" style="display: none;" />
        <button type="button" id="browseBtn" class="mt-2 rounded-xl bg-slate-900 text-white px-4 py-2">Browse Files</button>
      </form>
      <div id="uploadStatus" class="mt-2 text-sm text-slate-600"></div>
    </div>

    <!-- Runs table -->
    <div>
      <div class="mb-2 flex justify-between items-center">
        <div class="text-slate-900 font-semibold">Recent runs</div>
        <button id="exportCsv" class="rounded-xl border px-3 py-2 text-sm bg-white hover:bg-slate-50">Export CSV</button>
      </div>
      <div class="rounded-2xl border border-slate-200 bg-white shadow-sm overflow-hidden">
        <table class="min-w-full">
          <thead class="bg-slate-50 text-slate-600">
            <tr>
              <th class="px-4 py-2">Run ID</th>
              <th class="px-4 py-2">Invoice</th>
              <th class="px-4 py-2">Vendor</th>
              <th class="px-4 py-2">Status</th>
              <th class="px-4 py-2">Items</th>
              <th class="px-4 py-2">Bill</th>
              <th class="px-4 py-2">When</th>
            </tr>
          </thead>
          <tbody id="runsTbody" class="divide-y divide-slate-200"></tbody>
        </table>
      </div>
      <div class="flex justify-between my-4">
        <button id="prevPage" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">Prev</button>
        <button id="nextPage" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">Next</button>
      </div>
    </div>
  </main>

  <script>
    console.log('Script starting...');
    
    // Immediate test - just check if elements exist
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, testing elements...');
      const browseBtn = document.getElementById('browseBtn');
      console.log('Browse button found:', !!browseBtn);
    });
    
    const API_DEFAULT = 'http://localhost:5050';
    const API_BASE = (localStorage.getItem('API_BASE') || API_DEFAULT).replace(/\/$/, '');

    let nextCursor = null;
    let prevCursors = [];
    const PAGE_SIZE = 20;

    async function apiInfo(){
      const headers = {};
      const token = localStorage.getItem('API_TOKEN');
      if (token) headers['X-Auth-Token'] = token;
      const r = await fetch(API_BASE + '/api/info', { headers });
      return r.json();
    }

    async function apiListRuns(limit, cursor){
      const u = new URL(API_BASE + '/api/runs');
      if (limit) u.searchParams.set('limit', String(limit));
      if (cursor) u.searchParams.set('cursor', String(cursor));
      const headers = {};
      const token = localStorage.getItem('API_TOKEN');
      if (token) headers['X-Auth-Token'] = token;
      const r = await fetch(u.toString(), { headers });
      return await r.json();
    }

    async function apiIngest(file){
      const fd = new FormData();
      fd.append('file', file, file.name || 'upload.pdf');
      const headers = {};
      const token = localStorage.getItem('API_TOKEN');
      if (token) headers['X-Auth-Token'] = token;
      const r = await fetch(API_BASE + '/api/runs/ingest', { method: 'POST', body: fd, headers });
      return await r.json();
    }

    function ago(ts){
      const d = Date.now() - Number(ts||0);
      const s = Math.floor(d/1000);
      const m = Math.floor(s/60);
      const h = Math.floor(m/60);
      const day = Math.floor(h/24);
      if (day>0) return day+'d ago';
      if (h>0) return h+'h ago';
      if (m>0) return m+'m ago';
      return s+'s ago';
    }

    function renderRuns(runs){
      const tb = document.getElementById('runsTbody');
      tb.innerHTML = '';
      for (const run of runs){
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50 cursor-pointer';
        
        // Determine status chip styling
        let statusClass = 'bg-slate-100 text-slate-700 border border-slate-200'; // default
        const statusLower = (run.status || '').toLowerCase();
        if (statusLower === 'success') {
          statusClass = 'bg-green-100 text-green-800 border border-green-200';
        } else if (statusLower === 'warning') {
          statusClass = 'bg-amber-100 text-amber-800 border border-amber-200';
        } else if (statusLower === 'error') {
          statusClass = 'bg-red-100 text-red-800 border border-red-200';
        }
        
        tr.innerHTML = `
          <td class="px-4 py-2 font-mono text-sm text-blue-700 underline">${run.id}</td>
          <td class="px-4 py-2">${run.invoiceNo || '—'}</td>
          <td class="px-4 py-2">${run.vendor || '—'}</td>
          <td class="px-4 py-2"><span class="${statusClass} rounded-full px-2 py-0.5 text-xs">${run.status}</span></td>
          <td class="px-4 py-2">${(run.items||[]).length}</td>
          <td class="px-4 py-2">${run.billLink ? '<a href="'+run.billLink+'" target="_blank">Open</a>' : '—'}</td>
          <td class="px-4 py-2">${ago(run.createdAt)}</td>
        `;
        tr.addEventListener('click', (e)=>{
          if (!e.target.closest('a')){
            location.href = 'run.html?id=' + run.id;
          }
        });
        tb.appendChild(tr);
      }
    }

    async function loadPage(cursor, back=false){
      const { runs, nextCursor: nc } = await apiListRuns(PAGE_SIZE, cursor);
      renderRuns(runs);
      nextCursor = nc;
      if (!back && cursor) prevCursors.push(cursor);
      document.getElementById('prevPage').disabled = prevCursors.length===0;
      document.getElementById('nextPage').disabled = !nextCursor;
    }

    function initUpload(){
      console.log('initUpload function called');
      
      const dz = document.getElementById('dropZone');
      const input = document.getElementById('fileInput');
      const form = document.getElementById('uploadForm');
      const browseBtn = document.getElementById('browseBtn');
      
      console.log('Elements found:', { 
        dropZone: !!dz, 
        fileInput: !!input, 
        form: !!form, 
        browseBtn: !!browseBtn
      });
      
      if (!browseBtn || !input) {
        console.error('Required elements not found!');
        return;
      }
      
      // Drag and drop functionality
      if (dz) {
        dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('bg-slate-50'); });
        dz.addEventListener('dragleave', e=>{ dz.classList.remove('bg-slate-50'); });
        dz.addEventListener('drop', async e=>{
          e.preventDefault(); dz.classList.remove('bg-slate-50');
          const files = Array.from(e.dataTransfer.files);
          for (const f of files){ await apiIngest(f); }
          loadPage(null);
        });
      }
      
      // Browse button functionality - trigger file input
      browseBtn.addEventListener('click', function(e) {
        console.log('Browse button clicked!');
        e.preventDefault();
        e.stopPropagation();
        input.click();
      });
      
      // Also allow clicking the drop zone to select files
      if (dz) {
        dz.addEventListener('click', function(e) {
          console.log('Drop zone clicked, target:', e.target);
          if (e.target === dz || e.target.tagName === 'P') {
            console.log('Triggering file input from drop zone');
            input.click();
          }
        });
      }
      
      // File input change - auto-submit when file is selected
      input.addEventListener('change', async e=>{
        if (e.target.files && e.target.files.length > 0) {
          document.getElementById('uploadStatus').textContent = 'Uploading...';
          
          try {
            // Submit the form to /upload
            const formData = new FormData(form);
            const response = await fetch('/upload', {
              method: 'POST',
              body: formData
            });
            
            if (response.ok) {
              const result = await response.json();
              document.getElementById('uploadStatus').textContent = 'Upload complete!';
              loadPage(null);
            } else {
              const error = await response.json();
              document.getElementById('uploadStatus').textContent = `Upload failed: ${error.error || 'Unknown error'}`;
            }
          } catch (error) {
            document.getElementById('uploadStatus').textContent = 'Upload failed. Please try again.';
            console.error('Upload error:', error);
          }
          
          // Reset form
          input.value = '';
          setTimeout(() => {
            document.getElementById('uploadStatus').textContent = '';
          }, 3000);
        }
      });
    }

    async function init(){
      try {
        const info = await apiInfo();
        const statusBanner = document.getElementById('statusBanner');
        
        // Determine Zoho mode and connection status
        let zohoModeHtml;
        if (info.zoho.mode === 'live') {
          zohoModeHtml = `<span class="text-green-600 font-medium">Zoho: live</span>`;
        } else {
          zohoModeHtml = `<span class="text-gray-600">Zoho: mock</span>`;
        }
        
        // Add connection status
        let connectionStatusHtml = '';
        if (info.zoho.connected && info.zoho.valid) {
          connectionStatusHtml = ` <span class="text-green-600">(connected)</span>`;
        } else if (info.zoho.connected && !info.zoho.valid) {
          connectionStatusHtml = ` <span class="text-red-600">(expired)</span>`;
        } else {
          connectionStatusHtml = ` <span class="text-gray-500">(not connected)</span>`;
        }
        
        statusBanner.innerHTML = `${zohoModeHtml}${connectionStatusHtml} | Parser: ${info.parser.configured?'on':'off'}`;
        
        await loadPage(null);
        document.getElementById('nextPage').addEventListener('click', ()=> loadPage(nextCursor));
        document.getElementById('prevPage').addEventListener('click', ()=> {
          const prev = prevCursors.pop();
          loadPage(prev, true);
        });
        document.getElementById('exportCsv').addEventListener('click', ()=> {
          window.open(API_BASE + '/api/runs/export', '_blank');
        });
      } catch (error) {
        console.error('Init error:', error);
        document.getElementById('statusBanner').innerHTML = 'Error loading data';
      }
    }
    
    // Initialize upload functionality immediately, don't wait for init()
    initUpload();
    
    // Initialize the rest
    init();
  </script>
</body>
</html>
