<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Zoho Bills Automation Console — Run Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100">
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-8 w-8 rounded-xl bg-blue-600"></div>
        <div class="font-semibold text-slate-900">Zoho Bills Automation — Demo</div>
      </div>
      <nav class="flex gap-1 rounded-xl bg-slate-100 p-1">
        <a class="px-3 py-1.5 rounded-lg text-sm" href="index.html">Dashboard</a>
        <a class="px-3 py-1.5 rounded-lg text-sm" href="settings.html">Settings</a>
        <a class="px-3 py-1.5 rounded-lg text-sm" href="logs.html">Logs</a>
      </nav>
    </div>
  </div>

  <main class="mx-auto max-w-7xl p-4 space-y-6">
    <a href="index.html" class="text-blue-700 underline">&larr; Back</a>
    <div id="runCard" class="rounded-2xl border p-4 bg-white"></div>

    <div class="flex gap-2 flex-wrap">
      <button id="btnCreateDraft" class="rounded bg-slate-900 text-white px-4 py-2">Create Draft Bill</button>
      <button id="btnViewParsed" class="rounded border px-4 py-2">View parsed JSON</button>
      <button id="btnViewZoho" class="rounded border px-4 py-2">View Zoho I/O</button>
      <a id="btnDownloadParsed" class="rounded border px-4 py-2" download="parsed.json">Download parsed.json</a>
      <a id="btnDownloadZoho" class="rounded border px-4 py-2" download="zoho.json">Download zoho.json</a>
      <a id="btnDownloadPDF" class="rounded border px-4 py-2">Download PDF</a>
      <button id="btnDelete" class="rounded bg-red-600 text-white px-4 py-2">Delete Run</button>
      <a id="billLink" target="_blank" class="text-blue-700 underline hidden">Open Bill</a>
      <div id="actionMsg" class="text-sm text-slate-600"></div>
    </div>

    <div id="itemsCard" class="rounded-2xl border bg-white"></div>
  </main>

  <script>
    const API_BASE = (localStorage.getItem('API_BASE') || 'http://localhost:5050').replace(/\/$/,'');

    function q(k){ return new URLSearchParams(location.search).get(k); }
    function openJsonWindow(obj,title){
      const w=window.open('', '_blank');
      w.document.write('<pre>'+JSON.stringify(obj,null,2)+'</pre>');
    }

    async function apiGetRun(id){ return (await fetch(API_BASE+'/api/runs/'+id)).json().then(j=>j.run); }
    async function apiCreateDraft(id){ return (await fetch(API_BASE+'/api/runs/'+id+'/zoho/draft',{method:'POST'})).json(); }
    async function apiViewParsed(id){ return (await fetch(API_BASE+'/api/runs/'+id+'/parsed')).json(); }
    async function apiViewZoho(id){ return (await fetch(API_BASE+'/api/runs/'+id+'/zoho')).json(); }
    async function apiDeleteRun(id){ return (await fetch(API_BASE+'/api/runs/'+id,{method:'DELETE'})).json(); }

    async function init(){
      const id = q('id');
      const run = await apiGetRun(id);
      document.getElementById('runCard').textContent = 'Run '+run.id+' — Vendor: '+run.vendor;

      document.getElementById('btnCreateDraft').onclick=async()=>{
        await apiCreateDraft(id); alert('Draft created (mock)');
      };
      document.getElementById('btnViewParsed').onclick=async()=>openJsonWindow(await apiViewParsed(id),'Parsed');
      document.getElementById('btnViewZoho').onclick=async()=>openJsonWindow(await apiViewZoho(id),'Zoho');
      document.getElementById('btnDownloadParsed').href=API_BASE+'/api/runs/'+id+'/parsed';
      document.getElementById('btnDownloadZoho').href=API_BASE+'/api/runs/'+id+'/zoho';
      document.getElementById('btnDownloadPDF').href=API_BASE+'/api/runs/'+id+'/file';
      document.getElementById('btnDelete').onclick=async()=>{ await apiDeleteRun(id); location.href='index.html'; };
    }
    init();
  </script>
</body>
</html>
